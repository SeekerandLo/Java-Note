## æ³¨è§£

## æ³¨å†Œ Bean
1. [å››å¤§æ³¨è§£](#å£°æ˜bean)+[åŒ…æ‰«æ](#ç»„ä»¶æ‰«æ-@ComponentScan)
    - [ç»„ä»¶æ‰«æè¿‡æ»¤è§„åˆ™](#è¿‡æ»¤è§„åˆ™-FilterType(Enum))
2. [@Bean](#Bean)
3. [@Import](#å¯¼å…¥ç»„ä»¶-@Import)
4. [FactoryBean](#FactoryBean)

5. [@Scope-æ§åˆ¶ä½œç”¨åŸŸ](#è®¾ç½®ç»„ä»¶ä½œç”¨åŸŸ-@Scope)
6. [@Condition-æŒ‰ç…§æ¡ä»¶æ³¨å†ŒBean](#æŒ‰ç…§æ¡ä»¶æ³¨å†ŒBean-@Condition)

## ç”Ÿå‘½å‘¨æœŸ
1. [@Beanè®¾ç½®initMethodå’ŒdestroyMethod](#@Bean)

2. [Beanå®ç°æ¥å£](#å®ç°æ¥å£æ§åˆ¶Bean)

3. [JSR250è§„å®šçš„æ³¨è§£](#@PostConstruct-&-@PreDestroy)

4. é¡ºåº   
    - åˆ›å»ºå¯¹è±¡  
    &emsp;&emsp;â†“  
    - åˆå§‹åŒ–ä¹‹å‰ [BeanPostProcessor.postProcessBeforeInitialization()](#æ¥å£-BeanPostProcessor)  
    &emsp;&emsp;â†“  
    - åˆå§‹åŒ–ï¼šä½¿ç”¨@Beanæ³¨è§£ä¸­çš„æ–¹æ³•ï¼Œæˆ–è€…è®©Beanå®ç°æ¥å£   
    &emsp;&emsp;â†“
    - åˆå§‹åŒ–ä¹‹å [BeanPostProcessor.postProcessAfterInitialization()]((#æ¥å£-BeanPostProcessor)  )  
    &emsp;&emsp;â†“
    - é”€æ¯
        - å•å®ä¾‹çš„Beanä¼šåœ¨å®¹å™¨å…³é—­çš„æ—¶å€™é”€æ¯
        - å¤šå®ä¾‹çš„è‡ªå·±ç®¡ç†

### å£°æ˜bean
- @Compent   
- @Service
- @Controller
- @Repository


### è®¾ç½®ç»„ä»¶ä½œç”¨åŸŸ @Scope 
- prototype ç»„ä»¶è®¾ç½®ä¸ºå¤šä¾‹çš„ï¼Œå½“è®¾ç½®ä½œç”¨åŸŸå±æ€§ä¸ºå¤šä¾‹æ—¶ä¸ä¼šåœ¨åˆå§‹åŒ– Ioc å®¹å™¨æ—¶åˆ›å»ºï¼Œè€Œæ˜¯åœ¨ä½¿ç”¨è¯¥ Bean æ—¶åˆ›å»ºï¼Œæ¯æ¬¡éƒ½æ˜¯æ–°åˆ›å»ºçš„

- singleton å•ä¾‹çš„(é»˜è®¤å€¼)ï¼ŒIoC å®¹å™¨åˆå§‹åŒ–æ—¶åˆ›å»ºï¼Œä¹‹åå†ä½¿ç”¨éƒ½ Bean éƒ½æ˜¯ä½¿ç”¨ä¹‹å‰çš„ã€‚
    - æ‡’åŠ è½½ï¼š**@Lazy** å®¹å™¨å¯åŠ¨æ—¶å…ˆä¸åˆ›å»ºå¯¹è±¡ï¼Œå½“ä½¿ç”¨æ—¶æ‰åˆ›å»º

### æŒ‰ç…§æ¡ä»¶æ³¨å†ŒBean @Condition
- è‡ªå®šä¹‰Condition
    ```java
    // è‡ªå®šä¹‰
   public class MyCondition implements Condition {
        /**
        * @param context  åˆ¤æ–­ä¸Šä¸‹æ–‡ç¯å¢ƒ
        * @param metadata æ³¨é‡Šä¿¡æ¯
        */
        @Override
        public boolean matches(ConditionContext context, AnnotatedTypeMetadata metadata) {
            // å½“å‰ Bean å·¥åœº
            ConfigurableListableBeanFactory factory = context.getBeanFactory();
            System.out.println(factory);
            // ç±»
            ClassLoader classLoader = context.getClassLoader();
            System.out.println(classLoader);
            // ç¯å¢ƒ
            Environment environment = context.getEnvironment();
            // Bean æ³¨å†Œ
            BeanDefinitionRegistry beanDefinitionRegistry = context.getRegistry();
            // åˆ¤æ–­ return ...    
            return false;
        }
    }

    // ä½¿ç”¨-åœ¨æ–¹æ³•ä¸Šï¼Œå¦‚åŠ è½½Beanä¸Šï¼Œæ»¡è¶³æ¡ä»¶æ‰ä¼šåŠ è½½
    @Conditional(MyCondition.class)
    @Bean("user2")
    public User user2() {
        return new User("www", 3);
    }

    // ä½¿ç”¨åœ¨ç±»ä¸Šï¼Œå¦‚æœç±»æ»¡è¶³æ¡ä»¶ï¼Œä¸‹é¢çš„Beanæ‰ä¼šç”Ÿæ•ˆ
    ```

#### [ğŸ‘‰å›åˆ°é¡¶éƒ¨](#æ³¨è§£)

### ç»„ä»¶æ‰«æ @ComponentScan

- ç»„ä»¶æ³¨å†Œï¼Œè‡ªåŠ¨æ‰«æç»„ä»¶ï¼Œä½¿ç”¨ä»¥ä¸‹æ³¨è§£çš„ç±»ä¼šè¢«æ‰«ææ·»åŠ åˆ° IoC å®¹å™¨ä¸­ï¼Œ**é»˜è®¤è°ƒç”¨çš„æ˜¯ç±»ä¸­çš„æ— å‚æ„é€ å‡½æ•°**
    - @Service
    - @Component
    - @Contoller
    - @Repository 

- è¿‡æ»¤æ³¨è§£-åŒ…å«
    ```java
    @ComponentScan(value = "com.liy.spring", includeFilters = {
        @ComponentScan.Filter(type = FilterType.ANNOTATION, classes = {Controller.class})
    },useDefaultFilters = false)
    ```    

- è¿‡æ»¤æ³¨è§£-å»é™¤
    ```java
    @ComponentScan(value = "com.liy.spring", excludeFilters = {
        @ComponentScan.Filter(type = FilterType.ANNOTATION, classes = {Controller.class, Service.class})})
    ```
#### [ğŸ‘‰å›åˆ°é¡¶éƒ¨](#æ³¨è§£)

### è¿‡æ»¤è§„åˆ™ FilterType(Enum)
- ANNOTATION åŸºäºæ³¨è§£

- ASSIGNABLE_TYPE åŸºäºç»™å®šçš„ç±»å‹
    ```java
    @ComponentScan(value = "com.liy.spring", includeFilters = {
        @ComponentScan.Filter(type = FilterType.ASSIGNABLE_TYPE, classes ={TestController.class})
    }, useDefaultFilters = false)
    ```

- ASPECTJ ä½¿ç”¨ ASPECTJ è¡¨è¾¾å¼

- REGEX ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…

- CUSTOM è‡ªå®šä¹‰è§„åˆ™
    ```java
    // è‡ªå®šä¹‰è¿‡æ»¤å™¨
    public class MyTypeFiler implements TypeFilter {
        /**
        * @param metadataReader        å½“å‰æ­£åœ¨è¯»çš„ç±»çš„ä¿¡æ¯
        * @param metadataReaderFactory è·å–åˆ°å…¶ä»–ä»»ä½•ç±»çš„ä¿¡æ¯
        */
        @Override
        public boolean match(MetadataReader metadataReader, MetadataReaderFactory metadataReaderFactory) throws IOException {
            // è·å–å½“å‰ç±»çš„æ³¨è§£ä¿¡æ¯
            AnnotationMetadata annotationMetadata = metadataReader.getAnnotationMetadata();
            // è·å–å½“å‰ç±»çš„ä¿¡æ¯
            ClassMetadata classMetadata = metadataReader.getClassMetadata();
            // è·å–å½“å‰ç±»èµ„æºä¿¡æ¯ï¼šè·¯å¾„
            Resource resource = metadataReader.getResource();

            String className = classMetadata.getClassName();
            // åŒ¹é…ç±»åä¸­åŒ…å«erçš„ç±»    
            return className.contains("er");
        }
    }

    // ä½¿ç”¨è¿‡æ»¤å™¨
    @ComponentScan(value = "com.liy.spring", includeFilters = {
        @ComponentScan.Filter(type = FilterType.CUSTOM, classes = {
                MyTypeFiler.class
        })
    }, useDefaultFilters = false)
    ```
#### [ğŸ‘‰å›åˆ°é¡¶éƒ¨](#æ³¨è§£)

### å¯¼å…¥ç»„ä»¶ @Import   
- å¼•å…¥ç»„ä»¶
    ```java
    @Import(Color.class)
    public class Test{

    }
    ```

- æ¥å£ï¼šImportSelector
    ```java
    public class MyImportSelector implements ImportSelector {
        // AnnotationMetadata å½“å‰ç±»çš„æ³¨è§£ä¿¡æ¯
        @Override
        public String[] selectImports(AnnotationMetadata importingClassMetadata) {
            System.out.println(importingClassMetadata);
            // æ·»åŠ ç±» return     
            return new String[0];
        }
    }

    // ä½¿ç”¨
    @Import(MyImportSelector.class)
    public class Test{

    }    
    ```    
- æ¥å£ï¼šImportBeanDefinitionRegistrar
    ```java
    public class MyImportBeanDefinitionRegistrar implements ImportBeanDefinitionRegistrar {
        /**
        * @param importingClassMetadata å½“å‰ç±»çš„æ³¨è§£ä¿¡æ¯
        * @param registry               Beançš„æ³¨å†Œ
        */
        @Override
        public void registerBeanDefinitions(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry) {
            // è¿›è¡Œåˆ¤æ–­ç„¶åæ³¨å†ŒBean
            
        }
    }

    // ä½¿ç”¨
    @Import(MyImportBeanDefinitionRegistrar.class)
    public class Test{

    }    
    ```
#### [ğŸ‘‰å›åˆ°é¡¶éƒ¨](#æ³¨è§£)

### FactoryBean
- åˆ›å»ºè‡ªå·±çš„FactoryBeanï¼Œå®ç°FactoryBeanæ¥å£
    ```java
    public class MyFactoryBean implements FactoryBean<Color> {
        // åˆ›å»ºBeanæ—¶ï¼Œè°ƒç”¨æ­¤ï¼Œè¿”å›ä¸€ä¸ªColorå¯¹è±¡ï¼Œæ·»åŠ åˆ°å®¹å™¨ä¸­
        @Override
        public Color getObject() throws Exception {
            System.out.println("è°ƒç”¨ ");
            return new Color();
        }

        @Override
        public Class<?> getObjectType() {
            return Color.class;
        }

        // true: è¿™ä¸ªBeanæ˜¯å•å®ä¾‹
        // falseï¼šåˆ›å»ºå¤šä¸ª
        @Override
        public boolean isSingleton() {
            return true;
        }
    }

    //UserConfig2.javaä¸‹  åˆ›å»º 
    @Bean
    public MyFactoryBean myFactoryBean() {
        return new MyFactoryBean();
    }

    // è·å–
     @Test
    public void test() {
        AnnotationConfigApplicationContext applicationContext = new AnnotationConfigApplicationContext(UserConfig2.class);

        // ç›´æ¥è·å–Beanï¼Œç±»å‹æ˜¯Colorï¼Œè·å–åˆ°æ˜¯å·¥å‚Beanåˆ›å»ºçš„å¯¹è±¡
        Object factoryBean = applicationContext.getBean("myFactoryBean");

        // åŠ ä¸Š&ï¼Œè·å–å·¥å‚Beanï¼Œç±»å‹æ˜¯MyFactoryBean
        Object factoryBean = applicationContext.getBean("&myFactoryBean");
    }
    ```

***
#### [ğŸ‘‰å›åˆ°é¡¶éƒ¨](#æ³¨è§£)

### @Bean
- initMethod & destroyMethod åˆå§‹åŒ–æ—¶è°ƒç”¨ init æ–¹æ³•ï¼Œå…³é—­å®¹å™¨æ—¶è°ƒç”¨ destroy æ–¹æ³•
    ```java
    // Car.java
    public class Car {
        public Car(){
            System.out.println("Car constructor");
        }

        public void init(){
            System.out.println("Car init");
        }

        public void destroy(){
            System.out.println("Car destroy");
        }
    }

    @Bean(initMethod = "init", destroyMethod = "destroy")
    public Car car() {
        return new Car();
    }
    ```
- ä¸Šè¿°æ˜¯é’ˆå¯¹å•å®ä¾‹çš„ Bean è€Œè¨€ï¼Œå¦‚æœæ˜¯å¤šå®ä¾‹çš„ Beanï¼Œåœ¨ç¬¬ä¸€æ¬¡ä½¿ç”¨æ—¶è°ƒç”¨ init æ–¹æ³•ï¼Œå®¹å™¨å…³é—­ä¸ä¼šè°ƒç”¨ destroy æ–¹æ³•ï¼Œè‡ªå·±ç®¡ç† 

#### [ğŸ‘‰å›åˆ°é¡¶éƒ¨](#æ³¨è§£)   

### å®ç°æ¥å£æ§åˆ¶Bean
- åˆå§‹åŒ–åˆ›å»ºï¼šInitializingBeanï¼Œé”€æ¯ï¼šDisposableBean
- 
    ```java
    @Component
    public class Cat implements InitializingBean, DisposableBean {
        @Override
        public void destroy() throws Exception {
            System.out.println("destroy...");
        }

        @Override
        public void afterPropertiesSet() throws Exception {
            System.out.println("init...");
        }
    }
    ```
### @PostConstruct & @PreDestroy
- ```java
  @Component
    public class Dog {
        public Dog() {
            System.out.println("åˆ›å»º");
        }
        // åˆ›å»ºèµ‹å€¼ä¹‹å
        @PostConstruct
        public void init(){
            System.out.println("åˆå§‹åŒ–");
        }
        // é”€æ¯å‰
        @PreDestroy
        public void destroy(){
            System.out.println("é”€æ¯");
        }

    }
  ```

#### [ğŸ‘‰å›åˆ°é¡¶éƒ¨](#æ³¨è§£)

### æ¥å£ BeanPostProcessor
- Bean å¤„ç†å™¨ï¼Œå®ç°æ­¤æ¥å£åœ¨ Bean åˆå§‹åŒ–ä¹‹å‰ä¸åˆå§‹åŒ–ä¹‹åè°ƒç”¨ï¼Œå½“æ‰«ææ³¨å†Œåˆ°è¯¥ç»„ä»¶æ—¶æ‰ä¼šä½¿ç”¨åˆ°
    ```java
    @Component
    public class MyBeanPostProcessor implements BeanPostProcessor {
        // åˆå§‹åŒ–ä¹‹å‰
        @Override
        public Object postProcessBeforeInitialization(Object bean, String beanName) throws BeansException {
            System.out.println("åˆå§‹åŒ–ä¹‹å‰ï¼š"+beanName);
            return bean;
        }

        // åˆå§‹åŒ–ä¹‹å
        @Override
        public Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException {
            System.out.println("åˆå§‹åŒ–ä¹‹åï¼š"+beanName);
            return bean;
        }
    }
    ```

- åŸç†ï¼šè°ƒç”¨é“¾   
    populateBean(beanName, mbd, instanceWrapper) ç»™Beanèµ‹å€¼  
        &emsp;&emsp;&emsp;&emsp;â†“  
    {  
        applyBeanPostProcessorsBeforeInitialization()  
        invokeMethods()  
        applyBeanPostProcessorsAfterInitialization()  
    }
    ***
    AbstractAutowireCapableBeanFactory
    ```java
    @Override
        public Object applyBeanPostProcessorsBeforeInitialization(Object existingBean, String beanName)
                throws BeansException {

            Object result = existingBean;
            for (BeanPostProcessor processor : getBeanPostProcessors()) {
                Object current = processor.postProcessBeforeInitialization(result, beanName);
                if (current == null) {
                    return result;
                }
                result = current;
            }
            return result;
        }
    ```
    ```java
    @Override
	public Object applyBeanPostProcessorsAfterInitialization(Object existingBean, String beanName)
			throws BeansException {

		Object result = existingBean;
		for (BeanPostProcessor processor : getBeanPostProcessors()) {
			Object current = processor.postProcessAfterInitialization(result, beanName);
			if (current == null) {
				return result;
			}
			result = current;
		}
		return result;
	}
    ```
#### [ğŸ‘‰å›åˆ°é¡¶éƒ¨](#æ³¨è§£)   

***

### Beanèµ‹å€¼ @Value
- æ”¯æŒåŸºæœ¬æ•°å€¼  
    æ”¯æŒ SpEL è¡¨è¾¾å¼ï¼š#{}  
    æ”¯æŒ ${}ï¼šå–å‡ºé…ç½®æ–‡ä»¶ä¸­çš„å€¼  
