## å‡ ä¸ªç‚¹éœ€è¦æ³¨æ„ 

1. åœ¨ BeanFactory çš„åˆ›å»ºè¿‡ç¨‹ä¸­å¦‚ä½•å¤„ç†å‡ ç§ BeanPostProcessor

2.  

## BeanFactory å¦‚ä½•åˆ›å»º: refresh()

- ### BeanFactory çš„å‡†å¤‡å·¥ä½œ

1. [prepareRefresh() åˆ·æ–°å‰çš„é¢„å¤„ç†](#prepareRefresh-åˆ·æ–°å‰çš„é¢„å¤„ç†)

2. [obtainFreshBeanFactory() è·å–BeanFactory](#obtainFreshBeanFactory-è·å–BeanFactory)

3. [prepareBeanFactory(beanFactory) å‡†å¤‡BeanFactory](#prepareBeanFactory(beanFactory)-å‡†å¤‡BeanFactory)

4. [postProcessBeanFactory(beanFactory) BeanFactoryçš„åç½®å¤„ç†](#postProcessBeanFactory(beanFactory)-BeanFactory-çš„åç½®å¤„ç†)
 
- ### Bean çš„å‡†å¤‡

5. [invokeBeanFactoryPostProcessors(beanFactory) æ‰§è¡ŒBeanFactoryçš„åç½®å¤„ç†](#invokeBeanFactoryPostProcessors(beanFactory)-æ‰§è¡ŒBeanFactoryPostProcessor-ä¸­çš„æ–¹æ³•)

6. [registerBeanPostProcessors(beanFactory) æ³¨å†ŒBeançš„åç½®å¤„ç†å™¨](#registerBeanPostProcessors(beanFactory)-æ³¨å†Œ-Bean-çš„åç½®å¤„ç†å™¨)

7. [initMessageSource() åˆå§‹åŒ–MessageSource](#initMessageSource())

8. [initApplicationEventMulticaster åˆå§‹åŒ–äº‹ä»¶æ´¾å‘å™¨](#initApplicationEventMulticaster)

9. [onRefresh() ç•™ç»™å­ç±»é‡å†™](#onRefresh()-ç•™ç»™å­ç±»é‡å†™)

10. [registerListeners() æ£€æŸ¥listenerå¹¶æ³¨å†Œ](#registerListeners()-æ£€æŸ¥listenerå¹¶æ³¨å†Œ)

11. [finishBeanFactoryInitialization(beanFactory) åˆå§‹åŒ–Bean](#finishBeanFactoryInitialization(beanFactory)-åˆå§‹åŒ–Bean)

12. [finishRefresh() å®Œæˆ BeanFactory çš„åˆå§‹åŒ–åˆ›å»º](#finishRefresh())
***

### prepareRefresh åˆ·æ–°å‰çš„é¢„å¤„ç†
    å‡†å¤‡åˆ·æ–°æ­¤ applicationContext

1. &emsp;initPropertySources()
    - åœ¨ä¸Šä¸‹æ–‡ç¯å¢ƒä¸­åˆå§‹åŒ–ä»»ä½•å ä½ç¬¦å±æ€§æº

2. &emsp;getEnvironment().validateRequiredProperties()
    - éªŒè¯æ‰€æœ‰æ ‡è®°ä¸ºâ€œå¿…éœ€â€çš„å±æ€§æ˜¯å¦å¯è§£æ 

3. &emsp;this.earlyApplicationListeners = new LinkedHashSet<>(this.applicationListeners)  
    &emsp;this.earlyApplicationEvents = new LinkedHashSet<>()
    
    - å­˜å‚¨é¢„åˆ·æ–°åº”ç”¨ç¨‹åºä¾¦å¬å™¨...
    
    - å…è®¸æ”¶é›†æ—©æœŸçš„ ApplicationEventsï¼Œä¸€æ—¦å¤šæ’­å¯ç”¨ï¼Œå°†å‘å¸ƒ...

### obtainFreshBeanFactory è·å–BeanFactory
    å‘Šè¯‰å­ç±»åˆ·æ–°å†…éƒ¨ BeanFactory
1. &emsp;refreshBeanFactory()
    - åˆ›å»ºä¸€ä¸ª BeanFactory   
    this.beanFactory = new DefaultListableBeanFactory()
    
    - è®¾ç½®id  
    this.beanFactory.setSerializationId(getId())

2. &emsp;return getBeanFactory()
    - è¿”å›åˆ›å»ºçš„ BeanFactory    

### prepareBeanFactory(beanFactory) å‡†å¤‡BeanFactory
    BeanFactory çš„å‡†å¤‡å·¥ä½œ
1. &emsp;è®¾ç½®å¥½å¤šå±æ€§ï¼ŒBeanFactory çš„ç±»åŠ è½½å™¨ã€æ”¯æŒè¡¨è¾¾å¼è§£æå™¨

2. &emsp;æ·»åŠ éƒ¨åˆ† BeanPostProcessor æœ‰ **ApplicationContextAwareProcessor**

3. &emsp;è®¾ç½®å¿½ç•¥ä¾èµ–æ¥å£

4. &emsp;å°†ä¸€äº›æ¥å£è®¾ç½®æˆå¯è‡ªåŠ¨è£…é…çš„ï¼Œå¯è§£æçš„
    
    - beanFactory.registerResolvableDependency(**BeanFactory.class**, beanFactory)  
	
    - beanFactory.registerResolvableDependency(**ResourceLoader.class**, this)
	
    - beanFactory.registerResolvableDependency
    (**ApplicationEventPublisher.class**, this)
	
    - beanFactory.registerResolvableDependency(**ApplicationContext.class**, this)

4. &emsp;å°† ApplicationListeners æ³¨å†Œä¸ºæ£€æµ‹å†…éƒ¨ Bean çš„æ—©æœŸåç½®å¤„ç†å™¨

    - beanFactory.addBeanPostProcessor(new ApplicationListenerDetector(this));

5. &emsp;æ£€æµ‹ LoadTimeWearverï¼Œå‡†å¤‡æ„å»ºï¼Œå¦‚æœæ‰¾åˆ°çš„è¯

6. &emsp;æ³¨å†Œé»˜è®¤çš„ç¯å¢ƒå˜é‡ Bean
    - ç¯å¢ƒå˜é‡

    - ç³»ç»Ÿå±æ€§

### postProcessBeanFactory(beanFactory) BeanFactory çš„åç½®å¤„ç†
    å…è®¸ä¸Šä¸‹æ–‡å­ç±»å¯¹ BeanFactory è¿›è¡Œåç½®å¤„ç†

1. &emsp;æä¾›æ–¹æ³•ç»™å­ç±»é‡å†™

### invokeBeanFactoryPostProcessors(beanFactory) æ‰§è¡ŒBeanFactoryPostProcessor ä¸­çš„æ–¹æ³•
    
    è°ƒç”¨åœ¨ä¸Šä¸‹æ–‡ä¸­æ³¨å†Œä¸º Bean çš„åç½®å¤„ç†å™¨

1. &emsp;PostProcessorRegistrationDelegate.invokeBeanFactoryPostProcessors(beanFactory, getBeanFactoryPostProcessors())

    - è·å–å½“å‰å®¹å™¨ä¸­çš„æ‰€æœ‰ BeanFactoryPostProcessorï¼ŒBeanFactoryPostProcessor æœ‰ä¸¤ç±»ï¼Œä¸€ç±»æ˜¯ç»§æ‰¿äº†å®ƒçš„ BeanDefinitionRegistryPostProcessor æ¥å£ï¼Œå¦ä¸€ç§æ˜¯å®ƒè‡ªå·±ï¼ŒBeanDefinitionRegistryPostProcessor åœ¨ Bean çš„æ³¨å†Œä¿¡æ¯å°†è¦è¢«è°ƒç”¨æ—¶åŠ è½½ï¼Œå¯ä»¥ä¿®æ”¹å½“å‰ä¸Šä¸‹æ–‡ä¸­ Bean çš„æ³¨å†Œä¿¡æ¯ï¼Œæ‰§è¡Œé¡ºåºï¼š BeanDefinitionRegistryPostProcessor åœ¨ BeanFactoryPostProcessor ä¹‹å‰

    - å…ˆè·å– BeanDefinitionRegistryPostProcessorï¼Œç„¶åæ‰§è¡Œå®¹å™¨ä¸­çš„ BeanDefinitionRegistryPostProcessor æŒ‰ç…§ ä¼˜å…ˆçº§(å®ç° **PriorityOrdered** æ¥å£)-> é¡ºåº(å®ç° **Ordered** æ¥å£) -> æ™®é€š(æ²¡æœ‰å®ç°ä¸Šè¿°ä¸¤ä¸ªæ¥å£) çš„é¡ºåºä¾æ¬¡æ‰§è¡Œ
    
    - å…ˆè·å– BeanFactoryPostProcessorï¼Œç„¶åæ‰§è¡Œå®¹å™¨ä¸­çš„ BeanFactoryPostProcessor æŒ‰ç…§ ä¼˜å…ˆçº§(å®ç° **PriorityOrdered** æ¥å£)-> é¡ºåº(å®ç° **Ordered** æ¥å£) -> æ™®é€š(æ²¡æœ‰å®ç°ä¸Šè¿°ä¸¤ä¸ªæ¥å£) çš„é¡ºåºä¾æ¬¡æ‰§è¡Œ


### registerBeanPostProcessors(beanFactory) æ³¨å†Œ Bean çš„åç½®å¤„ç†å™¨
    æ³¨å†Œæ‹¦æˆª Bean çš„åˆ›å»ºçš„åç½®å¤„ç†å™¨

1. &emsp;è·å–æ‰€æœ‰çš„ BeanPostProcessorï¼ŒæŒ‰ç…§ ä¼˜å…ˆçº§(å®ç° **PriorityOrdered** æ¥å£)-> é¡ºåº(å®ç° **Ordered** æ¥å£) -> æ™®é€š(æ²¡æœ‰å®ç°ä¸Šè¿°ä¸¤ä¸ªæ¥å£) çš„é¡ºåºå°†è¿™äº›æ³¨å†Œåˆ° BeanFactory ä¸­

    - åœ¨ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­è¿˜ä¼šå¢åŠ ä¸€äº› BeanPostProcessor åˆ° BeanFactory ä¸­

### initMessageSource()
    ä¸ºæ­¤ä¸Šä¸‹æ–‡åˆå§‹åŒ–ä¿¡æ¯æº
1. &emsp;è·å– BeanFactoryï¼Œåˆ¤æ–­ BeanFactory ä¸­æ˜¯å¦å­˜åœ¨ **messageSource** çš„ Beanï¼Œå¦‚æœå­˜åœ¨ï¼Œèµ‹å€¼ç»™ this.messageSourceï¼Œå¦‚æœæ²¡æœ‰åˆ™åˆ›å»ºä¸€ä¸ª DelegatingMessageSourceï¼Œæ³¨å†Œåˆ° BeanFactory ä¸­

2. &emsp;å¦‚æœä»¥åéœ€è¦ç”¨åˆ° messageSourceï¼Œå¯ä»¥è‡ªåŠ¨æ³¨å…¥è¿™ä¸ª Beanï¼Œè°ƒç”¨ getMessage(...) æ–¹æ³•

### initApplicationEventMulticaster()
    åˆå§‹åŒ–äº‹ä»¶æ´¾å‘å™¨
1. &emsp;è·å– BeanFactoryï¼Œåˆ¤æ–­ BeanFactory ä¸­æ˜¯å¦å­˜åœ¨ **applicationEventMulticaster**ï¼Œå¦‚æœå­˜åœ¨ï¼Œèµ‹å€¼ç»™ this.applicationEventMulticasterï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œåˆ›å»ºä¸€ä¸ªSimpleApplicationEventMulticasterï¼Œæ³¨å†Œåˆ° BeanFactory ä¸­

### onRefresh() ç•™ç»™å­ç±»é‡å†™
    åˆå§‹åŒ–ç‰¹å®šä¸Šä¸‹æ–‡å­ç±»ä¸­çš„å…¶ä»–ç‰¹æ®Š Beans
1. &emsp;ç•™ç»™å­ç±»é‡å†™æ­¤æ–¹æ³•

### registerListeners() æ£€æŸ¥listenerå¹¶æ³¨å†Œ
    æ£€æŸ¥ listener Bean å¹¶æ³¨å†Œå®ƒä»¬

1. &emsp;é¦–å…ˆæ³¨å†Œé™æ€æŒ‡å®šçš„ listener

    - è·å–å…¨éƒ¨çš„ applicationListenerï¼Œæ·»åŠ åˆ° this.applicationEventMulticaster ä¸­å»

2. &emsp;å°†æ¯ä¸ªç›‘å¬å™¨åŠ å…¥åˆ°äº‹ä»¶æ´¾å‘å™¨ä¸­

3. &emsp;æ´¾å‘ **ä¹‹å‰** æ·»åŠ çš„äº‹ä»¶

### finishBeanFactoryInitialization(beanFactory) åˆå§‹åŒ–Bean
    åˆå§‹åŒ–æ‰€æœ‰å‰©ä¸‹çš„å•å®ä¾‹ Bean

1. &emsp;beanFactory.preInstantiateSingletons()   
    åˆå§‹åŒ–å‰©ä¸‹çš„å•å®ä¾‹ Bean
    
    - è·å–å®¹å™¨ä¸­çš„æ‰€æœ‰ Beanï¼Œä¾æ¬¡è¿›è¡Œåˆå§‹åŒ–å’Œåˆ›å»º

    - é¦–å…ˆæ‹¿åˆ° Bean çš„å®šä¹‰ä¿¡æ¯ï¼Œå¦‚æœ Bean **ä¸æ˜¯æŠ½è±¡çš„**ã€**æ˜¯å•å®ä¾‹çš„**ã€**ä¸æ˜¯æ‡’åŠ è½½çš„**ï¼Œåˆ™æ˜¯è¦åˆ›å»ºçš„ Bean
        - åˆ¤æ–­ Bean æ˜¯å¦æ˜¯ **FactoryBean**ï¼Œæœ‰ä¸åŒçš„åˆ›å»ºè¿‡ç¨‹

        - å¦‚æœæ˜¯ **FactoryBean**ï¼Œåˆ™è°ƒç”¨ FactoryBean ä¸­çš„ getObject

        - å¦‚æœä¸æ˜¯ **FactoryBean**ï¼Œåˆ™è°ƒç”¨ [getBean(beanName)](#getBean(beanName))ï¼Œåˆ›å»ºå¯¹è±¡

        - æ‰€æœ‰çš„ Bean éƒ½åˆ›å»ºå®Œæˆä¹‹åï¼Œåˆ¤æ–­ Bean æ˜¯å¦æ˜¯ SmartInitializingSingleton ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™æ‰§è¡Œ afterSingletonsInstantiated() æ–¹æ³•

### finishRefresh() 
    æœ€åä¸€æ­¥ï¼Œå‘å¸ƒå¯¹åº”äº‹ä»¶

- initLifecycleProcessor()  
    åˆå§‹åŒ–å’Œç”Ÿå‘½å‘¨æœŸæœ‰å…³çš„åç½®å¤„ç†å™¨
  
- getLifecycleProcessor().onRefresh()  

- publishEvent(new ContextRefreshedEvent(this))

- LiveBeansView.registerApplicationContext(this)
  


***

### getBean(beanName)
è°ƒç”¨ doGetBean()
- Object sharedInstance = getSingleton(beanName)  
é¦–å…ˆè·å–ç¼“å­˜ä¸­çš„å•å®ä¾‹ Bean

- ç¼“å­˜ä¸­è·å–ä¸åˆ°ï¼Œåˆ™è·å– BeanFactoryï¼Œ[çˆ¶å­å®¹å™¨ç›¸å…³ï¼Œæœªè®°å½•]()

- markBeanAsCreated(beanName)   
  æ ‡è®° Bean å·²ç»è¢«åˆ›å»ºï¼Œé˜²æ­¢å¤šçº¿ç¨‹åˆ›å»ºæ—¶åˆ›å»ºçš„ Bean ä¸æ˜¯å•å®ä¾‹

- è·å– Bean çš„å®šä¹‰ä¿¡æ¯  
  è·å– Bean çš„ä¾èµ–ä¿¡æ¯ String[] dependsOn = mbd.getDependsOn()ï¼Œå¦‚æœä¾èµ–çš„ Bean å…ˆä½¿ç”¨ [getBean](#getBean(beanName)) çš„æ–¹å¼è·å–ä¾èµ–çš„Bean

- sharedInstance = getSingleton(beanName, ()->{})  
  å¼€å§‹åˆ›å»ºå•å®ä¾‹ Bean 

    - createBean(beanName, mbd, args) ğŸ‘‡

        - Object bean = resolveBeforeInstantiation(beanName, mbdToUse)  

                ç»™ BeanPostProcessor ä¸€ä¸ªæœºä¼šè¿”å›ç›®æ ‡å®ä¾‹çš„ä»£ç†å¯¹è±¡
                
            æ˜¯è¿™ä¸ª **InstantiationAwareBeanPostProcessor**ï¼Œ æ‰§è¡Œè¿™ä¸ª BeanPostProcessor çš„ä¸¤ä¸ªæ–¹æ³•ï¼Œå¦‚æœ
            applyBeanPostProcessors**BeforeInstantiation** æœ‰è¿”å›å€¼ï¼Œåˆ™æ‰§è¡Œ applyBeanPostProcessors**AfterInitialization**

        - å¦‚æœ **InstantiationAwareBeanPostProcessor** æ²¡æœ‰è¿”å›ä»£ç†å¯¹è±¡ï¼Œåˆ™ç»§ç»­æ‰§è¡Œ  
        
        - Object beanInstance = [doCreateBean(beanName, mbdToUse, args)](#doCreateBean)   
        åˆ›å»º Bean

        - è¿”å›


### doCreateBean

- instanceWrapper = [createBeanInstance(beanName, mbd, args)](#createBeanInstance)  
        åˆ›å»º Bean å®ä¾‹     

- applyMergedBeanDefinitionPostProcessors(mbd, beanType, beanName)  
å…è®¸ BeanPostProcessor ä¿®æ”¹åˆå¹¶çš„ Bean å®šä¹‰
    
    - **MergedBeanDefinitionPostProcessor**

- **ã€Bean èµ‹å€¼ã€‘** [populateBean(beanName, mbd, instanceWrapper)](#populateBean)  
ä¸º Bean èµ‹å€¼   

- **ã€Bean åˆå§‹åŒ–ã€‘** [initializeBean(beanName, exposedObject, mbd)](#initializeBean)

- **ã€è·å–å•å®ä¾‹ Beanã€‘** Object earlySingletonReference = getSingleton(beanName, false)

- registerDisposableBeanIfNecessary(beanName, bean, mbd)  
æ³¨å†Œé”€æ¯æ–¹æ³•


### createBeanInstance

- instantiateUsingFactoryMethod(beanName, mbd, args) è°ƒç”¨å·¥å‚æ–¹æ³•æˆ– Bean çš„æ„é€ å™¨ åˆ›å»º Bean

### populateBean

- èµ‹å€¼ä¹‹å‰ï¼Œæ‹¿åˆ° **InstantiationAwareBeanPostProcessor**ï¼Œæ‰§è¡ŒpostProcessAfterInstantiation æ–¹æ³•

- ç»§ç»­æ‰§è¡Œï¼Œæ‹¿åˆ° **InstantiationAwareBeanPostProcessor**ï¼Œæ‰§è¡Œ postProcessProperties

- applyPropertyValues åº”ç”¨ Bean çš„ setter æ–¹æ³• **èµ‹å€¼**

### initializeBean

-  invokeAwareMethods(beanName, bean)   
æ‰§è¡Œ Aware æ¥å£çš„æ–¹æ³•

- applyBeanPostProcessorsBeforeInitialization(wrappedBean, beanName)
æ‰§è¡Œæ‰€æœ‰çš„åç½®å¤„ç†å™¨çš„åœ¨ Bean **åˆå§‹åŒ–ä¹‹å‰**çš„æ–¹æ³•

- invokeInitMethods(beanName, wrappedBean, mbd)  
**æ‰§è¡Œåˆå§‹åŒ–æ–¹æ³•**
    - åˆ¤æ–­ Bean æ˜¯å¦æ˜¯å®ç°äº† **InitializingBean** æ¥å£
    
    - æˆ–è€…æœ‰è‡ªå®šä¹‰çš„åˆå§‹åŒ–æ–¹æ³• 

- applyBeanPostProcessorsAfterInitialization(wrappedBean, beanName)  
æ‰§è¡Œæ‰€æœ‰çš„åç½®å¤„ç†å™¨çš„åœ¨ Bean **åˆå§‹åŒ–ä¹‹å**çš„æ–¹æ³•

- è¿”å› Bean
 